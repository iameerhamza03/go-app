name: Build and Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      short_sha: ${{ steps.vars.outputs.short_sha }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Generate a short SHA for a cleaner tag (e.g., a1b2c3d)
      - name: Set short SHA
        id: vars
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 2. Build and Push with unique tags and build-args for your Dockerfile labels
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/my-go-app:v1
            ${{ secrets.DOCKER_USERNAME }}/my-go-app:${{ steps.vars.outputs.short_sha }}
          build-args: |
            BUILD_VERSION=1.0.0
            COMMIT_SHA=${{ steps.vars.outputs.short_sha }}

      # 3. Update the description on the Docker Hub website automatically
      - name: Update Docker Hub Description
        uses: peter-evans/dockerhub-description@v4
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
          repository: ${{ secrets.DOCKER_USERNAME }}/my-go-app
          short-description: "Go App Build: ${{ steps.vars.outputs.short_sha }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: SSH into EC2 and Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            # Use the short SHA passed from the build job
            IMAGE_TAG=${{ needs.build-and-push.outputs.short_sha }}
            FULL_IMAGE="${{ secrets.DOCKER_USERNAME }}/my-go-app:$IMAGE_TAG"

            echo "Logging into Docker Hub..."
            echo "${{ secrets.DOCKER_PASSWORD }}" | sudo docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

            echo "Pulling new image: $FULL_IMAGE"
            sudo docker pull $FULL_IMAGE

            echo "Stopping and removing old container..."
            sudo docker stop go-server || true
            sudo docker rm go-server || true

            echo "Starting new container..."
            sudo docker run -d \
              --name go-server \
              --restart always \
              -p 8080:8080 \
              $FULL_IMAGE

            echo "Cleaning up old images..."
            sudo docker image prune -f
